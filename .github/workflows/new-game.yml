name: New Game

on:
  issues:
    types: [opened]

jobs:
  create-game:
    if: startsWith(github.event.issue.title, 'new game:')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create Game Branch
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.issue.title;
            const issueAuthor = context.payload.issue.user.login;
            const issueNumber = context.payload.issue.number;

            // Parse "new game: player1 vs player2"
            const match = title.match(/^new game:\s*(\S+)\s+vs\s+(\S+)$/i);
            if (!match) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `❌ Invalid format. Use: \`new game: player1 vs player2\``
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                state: 'closed'
              });
              return;
            }

            const [, playerX, playerO] = match;
            const branchName = `game/${playerX}-vs-${playerO}`;

            // Check if branch already exists
            try {
              await github.rest.repos.getBranch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: branchName
              });
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `❌ Game \`${branchName}\` already exists!`
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                state: 'closed'
              });
              return;
            } catch (e) {
              if (e.status !== 404) throw e;
            }

            // Get main branch SHA
            const { data: mainRef } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'heads/main'
            });

            // Create game branch
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/heads/${branchName}`,
              sha: mainRef.object.sha
            });

            // Create game.json content
            const gameState = {
              board: [null, null, null, null, null, null, null, null, null],
              players: { X: playerX, O: playerO },
              turn: 'X',
              winner: null
            };

            // Get current game.json to get its SHA
            const { data: currentFile } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'game.json',
              ref: branchName
            });

            // Update game.json on the new branch
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'game.json',
              message: `New game: ${playerX} (X) vs ${playerO} (O)`,
              content: Buffer.from(JSON.stringify(gameState, null, 2) + '\n').toString('base64'),
              sha: currentFile.sha,
              branch: branchName
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `✓ Game created!\n\n**${playerX}** (X) vs **${playerO}** (O)\n\nBranch: \`${branchName}\`\n\n${playerX} goes first. Fork the repo and open a PR to make your move!`
            });

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed',
              labels: ['game-created']
            });
