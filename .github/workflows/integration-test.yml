name: Integration Test

on:
  push:
    branches: [main]
    paths: ['.github/workflows/*.yml']
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup test game
        id: setup
        uses: actions/github-script@v7
        with:
          script: |
            const testId = `test-${Date.now()}`;
            const branch = `test-game/${testId}`;

            const { data: mainRef } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'heads/main'
            });

            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/heads/${branch}`,
              sha: mainRef.object.sha
            });

            const gameState = {
              board: [null,null,null,null,null,null,null,null,null],
              players: { X: 'github-actions[bot]', O: 'github-actions[bot]' },
              turn: 'X',
              winner: null
            };

            const { data: file } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'game.json',
              ref: branch
            });

            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'game.json',
              message: 'Setup test game',
              content: Buffer.from(JSON.stringify(gameState, null, 2)).toString('base64'),
              sha: file.sha,
              branch: branch
            });

            core.setOutput('branch', branch);
            console.log(`Created test branch: ${branch}`);

      - name: Test valid move
        id: test-valid
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ steps.setup.outputs.branch }}';
            const moveBranch = `${branch}-valid-move`;

            const { data: baseRef } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `heads/${branch}`
            });

            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/heads/${moveBranch}`,
              sha: baseRef.object.sha
            });

            const validMove = {
              board: [null,null,null,null,'X',null,null,null,null],
              players: { X: 'github-actions[bot]', O: 'github-actions[bot]' },
              turn: 'O',
              winner: null
            };

            const { data: file } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'game.json',
              ref: moveBranch
            });

            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'game.json',
              message: 'Valid move: X takes center',
              content: Buffer.from(JSON.stringify(validMove, null, 2)).toString('base64'),
              sha: file.sha,
              branch: moveBranch
            });

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '[TEST] Valid move',
              head: moveBranch,
              base: branch,
              body: 'Integration test - valid move'
            });

            console.log(`Created PR #${pr.number}`);
            core.setOutput('pr', pr.number);
            core.setOutput('moveBranch', moveBranch);

      - name: Wait for validation
        uses: actions/github-script@v7
        with:
          script: |
            const pr = ${{ steps.test-valid.outputs.pr }};

            // Poll for check status
            for (let i = 0; i < 12; i++) {
              await new Promise(r => setTimeout(r, 10000));

              const { data: prData } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr
              });

              const { data: checks } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: prData.head.sha
              });

              console.log(`Poll ${i+1}: Found ${checks.check_runs.length} checks`);
              for (const check of checks.check_runs) {
                console.log(`  - ${check.name}: ${check.status} / ${check.conclusion}`);
              }

              const validateCheck = checks.check_runs.find(c => c.name === 'validate');
              if (validateCheck && validateCheck.status === 'completed') {
                if (validateCheck.conclusion === 'success') {
                  console.log('âœ“ Valid move test PASSED');
                  return;
                } else {
                  core.setFailed(`Valid move should pass. Got: ${validateCheck.conclusion}`);
                  return;
                }
              }
            }

            core.setFailed('Timeout waiting for validation check');

      - name: Cleanup
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ steps.setup.outputs.branch }}';
            const moveBranch = '${{ steps.test-valid.outputs.moveBranch }}' || `${branch}-valid-move`;

            // Close PRs
            try {
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open'
              });

              for (const pr of prs.filter(p => p.head.ref.startsWith('test-game/'))) {
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  state: 'closed'
                });
                console.log(`Closed PR #${pr.number}`);
              }
            } catch (e) {
              console.log(`Error closing PRs: ${e.message}`);
            }

            // Delete branches
            for (const b of [branch, moveBranch]) {
              if (!b) continue;
              try {
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `heads/${b}`
                });
                console.log(`Deleted: ${b}`);
              } catch (e) {
                console.log(`Could not delete ${b}: ${e.message}`);
              }
            }
