name: Integration Test

on:
  push:
    branches: [main]
    paths: ['.github/workflows/*.yml']
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup test game
        id: setup
        uses: actions/github-script@v7
        with:
          script: |
            const testId = `test-${Date.now()}`;
            const branch = `test-game/${testId}`;

            // Create test branch from main
            const { data: mainRef } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'heads/main'
            });

            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/heads/${branch}`,
              sha: mainRef.object.sha
            });

            // Set up game state (github-actions[bot] vs itself)
            const gameState = {
              board: [null,null,null,null,null,null,null,null,null],
              players: { X: 'github-actions[bot]', O: 'github-actions[bot]' },
              turn: 'X',
              winner: null
            };

            const { data: file } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'game.json',
              ref: branch
            });

            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'game.json',
              message: 'Setup test game',
              content: Buffer.from(JSON.stringify(gameState, null, 2)).toString('base64'),
              sha: file.sha,
              branch: branch
            });

            core.setOutput('branch', branch);
            core.setOutput('testId', testId);
            console.log(`Created test branch: ${branch}`);

      - name: Test valid move
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ steps.setup.outputs.branch }}';
            const moveBranch = `${branch}-valid-move`;

            // Create move branch
            const { data: baseRef } = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `heads/${branch}`
            });

            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/heads/${moveBranch}`,
              sha: baseRef.object.sha
            });

            // Make valid move: X takes center
            const validMove = {
              board: [null,null,null,null,'X',null,null,null,null],
              players: { X: 'github-actions[bot]', O: 'github-actions[bot]' },
              turn: 'O',
              winner: null
            };

            const { data: file } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'game.json',
              ref: moveBranch
            });

            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: 'game.json',
              message: 'Valid move: X takes center',
              content: Buffer.from(JSON.stringify(validMove, null, 2)).toString('base64'),
              sha: file.sha,
              branch: moveBranch
            });

            // Create PR
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '[TEST] Valid move',
              head: moveBranch,
              base: branch,
              body: 'Integration test - valid move'
            });

            console.log(`Created PR #${pr.number} for valid move test`);

            // Wait for validation workflow
            await new Promise(r => setTimeout(r, 20000));

            // Check PR status
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: moveBranch
            });

            const validateCheck = checks.check_runs.find(c => c.name === 'validate');
            if (!validateCheck) {
              // Try waiting longer
              await new Promise(r => setTimeout(r, 15000));
              const { data: checks2 } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: moveBranch
              });
              const validateCheck2 = checks2.check_runs.find(c => c.name === 'validate');
              if (!validateCheck2 || validateCheck2.conclusion !== 'success') {
                core.setFailed(`Valid move should pass validation. Status: ${validateCheck2?.conclusion || 'not found'}`);
                return;
              }
            } else if (validateCheck.conclusion !== 'success') {
              core.setFailed(`Valid move should pass validation. Status: ${validateCheck.conclusion}`);
              return;
            }

            console.log('âœ“ Valid move test passed');

      - name: Cleanup
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ steps.setup.outputs.branch }}';

            // Close any open PRs
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${branch}`
            });

            for (const pr of prs) {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                state: 'closed'
              });
            }

            // Delete test branches
            const branches = [branch, `${branch}-valid-move`];
            for (const b of branches) {
              try {
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `heads/${b}`
                });
                console.log(`Deleted branch: ${b}`);
              } catch (e) {
                console.log(`Branch ${b} may not exist: ${e.message}`);
              }
            }
