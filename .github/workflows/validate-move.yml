name: Validate Move

on:
  pull_request_target:
    branches: ['game/**']

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0

      - name: Validate and Merge
        uses: actions/github-script@v7
        with:
          script: |
            const prAuthor = context.payload.pull_request.user.login;
            const prNumber = context.payload.pull_request.number;
            const baseRef = context.payload.pull_request.base.ref;
            const headSha = context.payload.pull_request.head.sha;

            // Get old game state from base branch
            const { execSync } = require('child_process');
            const oldState = JSON.parse(
              execSync(`git show origin/${baseRef}:game.json`).toString()
            );

            // Get new game state from PR (via API - don't checkout untrusted code)
            const { data: newFile } = await github.rest.repos.getContent({
              owner: context.payload.pull_request.head.repo.owner.login,
              repo: context.payload.pull_request.head.repo.name,
              path: 'game.json',
              ref: headSha
            });
            const newState = JSON.parse(Buffer.from(newFile.content, 'base64').toString());

            // Check game isn't already over
            if (oldState.winner) {
              core.setFailed(`Game already over. Winner: ${oldState.winner}`);
              return;
            }

            // Check it's this player's turn
            const expectedPlayer = oldState.players[oldState.turn];
            if (prAuthor !== expectedPlayer) {
              core.setFailed(`Not your turn! Waiting for ${expectedPlayer}, got ${prAuthor}`);
              return;
            }

            // Find what changed
            const changes = [];
            for (let i = 0; i < 9; i++) {
              if (oldState.board[i] !== newState.board[i]) {
                changes.push({ index: i, from: oldState.board[i], to: newState.board[i] });
              }
            }

            if (changes.length !== 1) {
              core.setFailed(`Must change exactly one cell. Found ${changes.length} changes.`);
              return;
            }

            const move = changes[0];

            if (move.from !== null) {
              core.setFailed(`Cell ${move.index} already occupied by ${move.from}`);
              return;
            }

            if (move.to !== oldState.turn) {
              core.setFailed(`Wrong symbol. Expected ${oldState.turn}, got ${move.to}`);
              return;
            }

            const nextTurn = oldState.turn === 'X' ? 'O' : 'X';
            if (newState.turn !== nextTurn && !newState.winner) {
              core.setFailed(`Turn should advance to ${nextTurn}`);
              return;
            }

            // Check winner calculation
            const lines = [
              [0,1,2], [3,4,5], [6,7,8],
              [0,3,6], [1,4,7], [2,5,8],
              [0,4,8], [2,4,6]
            ];
            let actualWinner = null;
            for (const [a,b,c] of lines) {
              if (newState.board[a] && newState.board[a] === newState.board[b] && newState.board[b] === newState.board[c]) {
                actualWinner = newState.board[a];
                break;
              }
            }
            if (newState.board.every(c => c !== null) && !actualWinner) {
              actualWinner = 'draw';
            }

            if (newState.winner !== actualWinner) {
              core.setFailed(`Winner should be ${actualWinner}, got ${newState.winner}`);
              return;
            }

            console.log(`✓ Valid move by ${prAuthor}: ${oldState.turn} -> cell ${move.index}`);
            if (actualWinner) {
              console.log(`Game over! Winner: ${actualWinner}`);
            }

            // Auto-merge the PR
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              merge_method: 'merge'
            });
            console.log(`✓ PR #${prNumber} auto-merged`);
